<section class="ali-root" *ngIf="!loading(); else skel">

  <!-- Header -->
  <header class="ali-header container">
    <a class="brand" routerLink="/" aria-label="Inicio NutriTrack">
      <strong>NutriTrack</strong>
    </a>
    <nav class="actions">
      <a routerLink="/dashboard" class="btn">Dashboard</a>
      <a routerLink="/profile" class="btn ghost">
        <lucide-icon [img]="SettingsIcon"></lucide-icon> Configuraciones
      </a>
    </nav>
  </header>

  <div class="container grid">
    <!-- Formulario / análisis -->
    <section class="card form-col">
      <h2 class="title">
        <lucide-icon [img]="UtensilsCrossedIcon"></lucide-icon> Registro de alimentación
      </h2>

      <!-- Tabs tipo comida -->
      <div class="meal-tabs" role="tablist" aria-label="Tipo de comida">
        <button class="tab" [class.sel]="mealType()==='breakfast'" (click)="mealType.set('breakfast')">
          <lucide-icon [img]="AppleIcon"></lucide-icon> Desayuno
        </button>
        <button class="tab" [class.sel]="mealType()==='lunch'" (click)="mealType.set('lunch')">
          <lucide-icon [img]="UtensilsCrossedIcon"></lucide-icon> Almuerzo
        </button>
        <button class="tab" [class.sel]="mealType()==='dinner'" (click)="mealType.set('dinner')">
          <lucide-icon [img]="UtensilsCrossedIcon"></lucide-icon> Cena
        </button>
        <button class="tab" [class.sel]="mealType()==='snack'" (click)="mealType.set('snack')">
          <lucide-icon [img]="AppleIcon"></lucide-icon> Snack
        </button>
      </div>

      <!-- Texto -->
      <label class="lbl">Describe tu comida (p.ej. "2 huevos, 1 taza de arroz, 1 manzana")</label>
      <textarea rows="3" class="food-input"
                [value]="text()"
                (input)="text.set($any($event.target).value)"
                placeholder="Puedes usar texto…"></textarea>

      <!-- Uploader PRO -->
      <div class="uploader" aria-label="Subir imagen de comida">
        <!-- Dropzone / Click-to-upload -->
        <div class="dropzone"
             tabindex="0"
             [class.dragover]="dzDrag()"
             (click)="fileInput?.click()"
             (keydown.enter)="fileInput?.click()"
             (keydown.space)="fileInput?.click()"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)">
          <div class="thumb">
            <img *ngIf="previewUrl(); else nu" [src]="previewUrl()!" alt="Vista previa" />
            <ng-template #nu>
              <lucide-icon [img]="UtensilsCrossedIcon"></lucide-icon>
            </ng-template>
          </div>

          <div class="file-meta">
            <div class="file-title">
              {{ previewName() || 'Arrastra tu foto aquí o haz click para elegir' }}
            </div>
            <div class="file-sub">
              <span *ngIf="previewSize()">{{ previewSize() }}</span>
              <span *ngIf="!previewUrl()">• PNG/JPG/WebP • Máx {{ maxMB }}MB</span>
            </div>
            <div class="pills" *ngIf="imgPublicUrl()">
              <span class="pill"><i class="dot-ok"></i> lista para IA</span>
            </div>
          </div>

          <div class="uploader-actions">
            <button class="btn ghost" type="button" (click)="fileInput?.click()" [disabled]="uploading()">Elegir</button>
            <button class="btn" type="button" (click)="viewImage()" *ngIf="imgPublicUrl()">Ver</button>
            <button class="btn ghost" type="button" (click)="removeImage()" *ngIf="previewUrl()">Quitar</button>
          </div>
        </div>

        <!-- input real escondido -->
        <input #fileInput type="file" accept="image/*" (change)="onFileInput($event)" hidden />

        <!-- Progreso y ayuda -->
        <div class="progress" *ngIf="uploading()"><i [style.--w.%]="uploadPct()"></i></div>
        <p class="helper">

        </p>

        <!-- Estado final tras subir (opcional) -->
        <div class="preview-card" *ngIf="imgPublicUrl() && !analysis()">
          <div class="left">
            <div class="thumb"><img [src]="previewUrl()!" alt="Vista previa" /></div>
            <div>
              <div class="file-title">Imagen lista para analizar</div>
              <div class="file-sub">{{ imgPath() }}</div>
            </div>
          </div>
          <div class="actions">
            <button class="btn" type="button" (click)="analyze()">Analizar con IA</button>
          </div>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" (click)="analyze()">Analizar con IA</button>
        <button class="btn ghost" (click)="openManualPrompt()">Agregar manual</button>
      </div>

      <!-- Resultado análisis -->
      <div class="analysis" *ngIf="analysis()">
        <!-- Mini tarjeta de imagen analizada (opcional) -->
        <div class="preview-card" *ngIf="imgPublicUrl()">
          <div class="left">
            <div class="thumb"><img [src]="previewUrl()!" alt="Vista previa" /></div>
            <div>
              <div class="file-title">Imagen analizada</div>
              <div class="file-sub">{{ imgPath() }}</div>
            </div>
          </div>
          <div class="actions">
            <button class="btn" type="button" (click)="viewImage()">Ver</button>
          </div>
        </div>

        <div class="kcal" style="margin-top:.5rem">
          <lucide-icon [img]="FlameIcon"></lucide-icon>
          <b>{{ analysis()!.kcal }}</b> kcal
          <span class="muted">• {{ analysis()!.protein_g }} g prot • {{ analysis()!.carbs_g }} g carb • {{ analysis()!.fat_g }} g grasa</span>
        </div>

        <div class="chips" *ngIf="analysis()!.meal_categories?.length">
          <span class="chip" *ngFor="let c of analysis()!.meal_categories">{{ c }}</span>
        </div>

        <ul class="items">
          <li *ngFor="let it of analysis()!.items">
            <span>
              {{ it.qty }} {{ it.unit || '' }} {{ it.name }}
              <small style="color:#b9c4d7; font-weight:700" *ngIf="it.categories.length"> – {{ it.categories.join(', ') }}</small>
            </span>
            <b>{{ it.kcal }} kcal</b>
          </li>
        </ul>

        <div class="row-actions">
          <button class="btn" (click)="addFromAnalysis()">Guardar (+{{ analysis()!.kcal }} kcal)</button>
        </div>
      </div>

      <p class="err" *ngIf="analysisErr()">{{ analysisErr() }}</p>
    </section>

    <!-- Overview / listado -->
    <section class="card overview">
      <h2 class="title">Resumen del día</h2>

      <div class="meter" role="progressbar"
           [attr.aria-valuemin]="0" [attr.aria-valuemax]="recKcal()" [attr.aria-valuenow]="todayTotal()">
        <div class="bar" [style.width.%]="pct()"></div>
        <div class="value">{{ todayTotal() }} / {{ recKcal() }} kcal</div>
      </div>

      <div class="totals">
        <div class="t" *ngFor="let k of mealKeys">
          <div class="k">{{ labelOf(k) }}</div>
          <div class="v">{{ totalFor(k) }} kcal</div>
        </div>
      </div>

      <div class="groups">
        <div class="group" *ngFor="let k of mealKeys">
          <div class="ghead">{{ labelOf(k) }}</div>
          <ul class="list">
            <li class="item" *ngFor="let m of groupList(k)">
              <div class="desc">{{ m.description }}</div>
              <div class="meta">
                <span class="kcal"><lucide-icon [img]="FlameIcon"></lucide-icon> {{ m.calories }} kcal</span>
                <span class="time"><lucide-icon [img]="ClockIcon"></lucide-icon> {{ fmtTime(m.logged_at) }}</span>
              </div>
              <button class="icon-btn danger" (click)="deleteLog(m)" aria-label="Eliminar">
                <lucide-icon [img]="Trash2Icon"></lucide-icon>
              </button>
            </li>
            <li class="empty" *ngIf="groupList(k).length === 0">Sin registros.</li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <p class="err center" *ngIf="err()">{{ err() }}</p>

  <!-- Modal manual kcal -->
  <div class="modal-backdrop" *ngIf="manualModalOpen()">
    <div class="modal-card">
      <header class="modal-head">
        <div class="title">Ingresar calorías manualmente</div>
        <button class="icon-btn" type="button" (click)="closeManual()" aria-label="Cerrar">×</button>
      </header>

      <div class="modal-body">
        <label class="lbl">Descripción base</label>
        <div class="base-desc">{{ manualBaseDesc() || text() || 'Registro' }}</div>

        <label class="lbl" style="margin-top:.5rem">Calorías (separadas por comas)</label>
        <input type="text" class="food-input" [value]="manualInput()"
               (input)="manualInput.set($any($event.target).value)"
               placeholder="Ej: 250, 120, 330">

        <div class="hint" style="margin:.35rem 0 .2rem; color:var(--muted); font-weight:800;">
          Vista previa
        </div>
        <ul class="items" *ngIf="manualPreview().length; else noPrev">
          <li *ngFor="let it of manualPreview()">
            <span>
              <lucide-icon [img]="FlameIcon"></lucide-icon>
              {{ (it.desc || 'Registro') }}
            </span>
            <b>{{ it.kcal }} kcal</b>
          </li>
        </ul>
        <ng-template #noPrev>
          <div class="empty">Ingresa una o más cantidades válidas.</div>
        </ng-template>

        <p class="err" *ngIf="manualErr()">{{ manualErr() }}</p>
      </div>

      <footer class="modal-foot">
        <button class="btn ghost" type="button" (click)="closeManual()">Cancelar</button>
        <button class="btn" type="button" (click)="saveManualEntries()">{{ manualSaving() ? 'Guardando…' : 'Guardar' }}</button>
      </footer>
    </div>
  </div>
</section>

<!-- Toast popup -->
<div class="toast" *ngIf="toastOpen()" [class.err]="toastType()==='err'">
  <div class="toast-inner">
    <lucide-icon [img]="toastType()==='ok' ? FlameIcon : Trash2Icon"></lucide-icon>
    <span>{{ toastMsg() }}</span>
  </div>
 </div>

<ng-template #skel>
  <div class="container loading">Cargando alimentación…</div>
</ng-template>
