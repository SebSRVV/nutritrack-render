<main class="prof-root" *ngIf="!loading(); else skeleton">
  <header class="prof-header container">
    <a routerLink="/" class="brand">
      <strong>NutriTrack</strong>
    </a>

    <div class="actions">
      <a class="btn btn-outline" routerLink="/dashboard">
        <lucide-icon [img]="ActivityIcon"></lucide-icon>
        Ir al panel
      </a>
      <button class="btn danger outline" (click)="openDeleteModal()">
        <lucide-icon [img]="Trash2Icon"></lucide-icon>
        Eliminar cuenta
      </button>
      <button class="btn btn-outline" (click)="logout()">
        <lucide-icon [img]="LogOutIcon"></lucide-icon>
        Cerrar sesión
      </button>
    </div>
  </header>

  <section class="container grid grid-2col">
    <!-- IZQUIERDA: Información -->
    <div class="col-left">
      <div class="card">
        <h2 class="title">Perfil profesional</h2>
        <p class="sub">Información de cuenta y métricas personales.</p>

        <!-- Identidad / sistema -->
        <div class="surface id-block">
          <div class="row">
            <div class="row-item">
              <div class="label"><lucide-icon [img]="MailIcon"></lucide-icon> Email</div>
              <div class="value mono">{{ email() }}</div>
            </div>
            <div class="row-item">
              <div class="label"><lucide-icon [img]="UserIcon"></lucide-icon> Usuario</div>
              <div class="value">{{ username() || '—' }}</div>
            </div>
          </div>
          <div class="row">
            <div class="row-item">
              <div class="label"><lucide-icon [img]="IdCardIcon"></lucide-icon> ID</div>
              <div class="value mono small">{{ userId() }}</div>
            </div>
            <div class="row-item">
              <div class="label"><lucide-icon [img]="ActivityIcon"></lucide-icon> Estado</div>
              <div class="value">{{ lastSignInAt() ? 'Activo' : '—' }}</div>
            </div>
          </div>
          <div class="row">
            <div class="row-item">
              <div class="label"><lucide-icon [img]="CalendarIcon"></lucide-icon> Creado</div>
              <div class="value mono">{{ createdAt() | date:'medium' }}</div>
            </div>
            <div class="row-item">
              <div class="label"><lucide-icon [img]="CalendarIcon"></lucide-icon> Último acceso</div>
              <div class="value mono">{{ lastSignInAt() | date:'medium' }}</div>
            </div>
          </div>
        </div>

        <!-- DATOS PERSONALES (2×2) -->
        <div class="surface personal-grid">
          <div class="personal-item">
            <div class="k"><lucide-icon [img]="CalendarIcon"></lucide-icon> Fecha de nacimiento</div>
            <div class="v mono">{{ dob() || '—' }}</div>
          </div>
          <div class="personal-item">
            <div class="k"><lucide-icon [img]="InfoIcon"></lucide-icon> Edad</div>
            <div class="v">{{ age() ?? '—' }} años</div>
          </div>
          <div class="personal-item">
            <div class="k"><lucide-icon [img]="CalendarIcon"></lucide-icon> Días para tu cumple</div>
            <div class="v">{{ daysToBday() ?? '—' }}</div>
          </div>
          <div class="personal-item">
            <div class="k"><lucide-icon [img]="InfoIcon"></lucide-icon> Sexo</div>
            <div class="v">{{ sex() === 'MALE' ? 'Hombre' : 'Mujer' }}</div>
          </div>
        </div>

        <div class="messages">
          <p class="success" *ngIf="successMessage()">{{ successMessage() }}</p>
          <p class="err server" *ngIf="serverError()">{{ serverError() }}</p>
        </div>
      </div>
    </div>

    <!-- DERECHA: Editores + Preferencias + BMI -->
    <aside class="col-right">
      <form (ngSubmit)="save()" [formGroup]="form" class="card editors" novalidate>
        <!-- Altura -->
        <div class="sliders">
          <div class="field-label">
            <lucide-icon [img]="RulerIcon"></lucide-icon> Altura (cm)
            <span class="chip">{{ form.controls.height_cm.value }} cm</span>
          </div>
          <div class="range-wrap">
            <input class="range" type="range" min="80" max="230" formControlName="height_cm">
          </div>
          <div class="meter">
            <div class="bar" [style.width.%]="heightPct()"></div>
            <div class="label">{{ heightPct() }}%</div>
          </div>
        </div>

        <!-- Peso -->
        <div class="sliders">
          <div class="field-label">
            <lucide-icon [img]="ScaleIcon"></lucide-icon> Peso (kg)
            <span class="chip cyan">{{ form.controls.weight_kg.value }} kg</span>
          </div>
          <div class="range-wrap">
            <input class="range cyan" type="range" min="25" max="250" formControlName="weight_kg">
          </div>
          <div class="meter cyan">
            <div class="bar" [style.width.%]="weightPct()"></div>
            <div class="label">{{ weightPct() }}%</div>
          </div>
        </div>

        <!-- PREFERENCIAS (ahora aquí, arriba del BMI) -->
        <div>
          <div class="segment-title">Nivel de actividad</div>
          <div class="segment-hint">Usado para tus cálculos de gasto energético.</div>
          <div class="segmented-3">
            <label>
              <input type="radio" name="activity" value="sedentary" [checked]="activityLevel()==='sedentary'" (change)="setActivity('sedentary')">
              <span>Sedentario</span>
            </label>
            <label>
              <input type="radio" name="activity" value="moderate" [checked]="activityLevel()==='moderate'" (change)="setActivity('moderate')">
              <span>Activo moderado</span>
            </label>
            <label>
              <input type="radio" name="activity" value="very_active" [checked]="activityLevel()==='very_active'" (change)="setActivity('very_active')">
              <span>Muy activo</span>
            </label>
          </div>
        </div>

        <div>
          <div class="segment-title">Tipo de dieta</div>
          <div class="segment-hint">Preferencia principal para objetivos.</div>
          <div class="segmented-3">
            <label>
              <input type="radio" name="diet" value="low_carb" [checked]="dietType()==='low_carb'" (change)="setDiet('low_carb')">
              <span>Sin carbohidratos</span>
            </label>
            <label>
              <input type="radio" name="diet" value="caloric_deficit" [checked]="dietType()==='caloric_deficit'" (change)="setDiet('caloric_deficit')">
              <span>Déficit calórico</span>
            </label>
            <label>
              <input type="radio" name="diet" value="surplus" [checked]="dietType()==='surplus'" (change)="setDiet('surplus')">
              <span>Aumento de Peso</span>
            </label>
          </div>
        </div>

        <!-- BMI -->
        <div class="surface bmi-card">
          <div class="bmi">
            <div class="bmi-left">
              <div class="bmi-ic" [ngClass]="bmiStatus().color">
                <lucide-icon [img]="HeartPulseIcon"></lucide-icon>
              </div>
              <div>
                <div class="bmi-title">Índice de Masa Corporal</div>
                <div class="bmi-val">{{ bmi() ?? '—' }}</div>
              </div>
            </div>
            <div class="bmi-right">
              <span class="pill" [ngClass]="bmiStatus().color">{{ bmiStatus().label }}</span>
            </div>
          </div>
        </div>

        <!-- Acciones centradas -->
        <div class="form-actions">
          <button class="btn btn-primary" type="submit" [disabled]="saving()">
            <lucide-icon [img]="SaveIcon"></lucide-icon>
            {{ saving() ? 'Guardando…' : 'Guardar cambios' }}
          </button>
        </div>
      </form>
    </aside>
  </section>

  <!-- Modal eliminar cuenta -->
  <div class="modal-backdrop" *ngIf="showDeleteModal()" (click)="closeDeleteModal()"></div>

  <div class="modal" *ngIf="showDeleteModal()" role="dialog" aria-modal="true" aria-labelledby="deleteTitle" aria-describedby="deleteDesc">
    <div>
      <div class="modal-header">
        <lucide-icon [img]="ShieldAlertIcon"></lucide-icon>
        <strong id="deleteTitle">Eliminar cuenta</strong>
        <span class="modal-badge">Acción permanente</span>
      </div>

      <p id="deleteDesc">
        Esta acción es permanente e irreversible. Escribe <b>eliminar</b> para confirmar.
      </p>

      <input class="confirm-input"
             [class.valid]="confirmText().toLowerCase()==='eliminar'"
             [class.invalid]="confirmText().length>0 && confirmText().toLowerCase()!=='eliminar'"
             type="text" placeholder="eliminar"
             [value]="confirmText()"
             (input)="confirmText.set($any($event.target).value)">

      <div class="modal-actions">
        <span class="modal-hint">Se cerrará tu sesión al confirmar.</span>
        <div>
          <button class="btn cancel" (click)="closeDeleteModal()">Cancelar</button>
          <button class="btn danger"
                  [disabled]="confirmText().toLowerCase() !== 'eliminar' || deleting()"
                  (click)="deleteAccount()">
            <lucide-icon [img]="Trash2Icon"></lucide-icon>
            {{ deleting() ? 'Eliminando…' : 'Eliminar' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<ng-template #skeleton>
  <div class="loading container">Cargando perfil…</div>
</ng-template>
